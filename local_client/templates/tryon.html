{% extends "base.html" %}

{% block title %}虚拟试穿 - IDM-VTON{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-magic"></i> 虚拟试穿</h1>
            <div>
                <button class="btn btn-outline-secondary" onclick="checkVtonService()">
                    <i class="bi bi-server"></i> 检查服务状态
                </button>
                <button class="btn btn-outline-info" onclick="showVtonHistory()">
                    <i class="bi bi-clock-history"></i> 试穿历史
                </button>
            </div>
        </div>

        <!-- 服务状态提示 -->
        <div id="serviceStatus" class="alert alert-info d-none">
            <i class="bi bi-info-circle"></i> 正在检查虚拟试穿服务状态...
        </div>

        <!-- 试穿界面 -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <!-- 左侧：图片选择 -->
                    <div class="col-md-8">
                        <div class="row">
                            <!-- 人物图片选择 -->
                            <div class="col-md-6">
                                <h5><i class="bi bi-person"></i> 选择人物图片</h5>
                                <div class="mb-3">
                                    <div class="category-tabs">
                                        <button class="btn btn-outline-primary active" onclick="loadUserImages('char', 'human')" data-category="char">
                                            <i class="bi bi-person"></i> 角色图片
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="loadUserImages('clothes', 'human')" data-category="clothes">
                                            <i class="bi bi-bag"></i> 其他图片
                                        </button>
                                    </div>
                                </div>
                                <div id="humanImageList" class="image-grid">
                                    <div class="text-center p-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="selectedHuman" class="selected-image-preview d-none slide-down">
                                    <h6><i class="bi bi-check-circle text-success"></i> 已选择的人物图片:</h6>
                                    <div class="position-relative d-inline-block">
                                        <img id="selectedHumanImg" src="" alt="选中的人物图片" class="img-thumbnail preview-image">
                                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0 clear-btn" onclick="clearSelection('human')" title="取消选择">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <small id="selectedHumanName" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>

                            <!-- 服装图片选择 -->
                            <div class="col-md-6">
                                <h5><i class="bi bi-bag"></i> 选择服装图片</h5>
                                <div class="mb-3">
                                    <div class="category-tabs">
                                        <button class="btn btn-outline-primary active" onclick="loadUserImages('clothes', 'garment')" data-category="clothes">
                                            <i class="bi bi-bag"></i> 服装图片
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="loadUserImages('char', 'garment')" data-category="char">
                                            <i class="bi bi-person"></i> 其他图片
                                        </button>
                                    </div>
                                </div>
                                <div id="garmentImageList" class="image-grid">
                                    <div class="text-center p-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="selectedGarment" class="selected-image-preview d-none slide-down">
                                    <h6><i class="bi bi-check-circle text-success"></i> 已选择的服装图片:</h6>
                                    <div class="position-relative d-inline-block">
                                        <img id="selectedGarmentImg" src="" alt="选中的服装图片" class="img-thumbnail preview-image">
                                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0 clear-btn" onclick="clearSelection('garment')" title="取消选择">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <small id="selectedGarmentName" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：参数设置 -->
                    <div class="col-md-4">
                        <h5><i class="bi bi-sliders"></i> 试穿参数</h5>
                        
                        <!-- 服装描述 -->
                        <div class="mb-3">
                            <label for="garmentDescription" class="form-label">服装描述</label>
                            <input type="text" class="form-control" id="garmentDescription" 
                                   placeholder="例如: a white shirt, a blue dress" value="a shirt">
                            <div class="form-text">描述服装类型，帮助AI更好地理解</div>
                        </div>

                        <!-- 自动遮罩 -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoMask" checked>
                                <label class="form-check-label" for="autoMask">
                                    自动生成遮罩
                                </label>
                            </div>
                            <div class="form-text">使用AI自动检测人物身体部位</div>
                        </div>

                        <!-- 自动裁剪 -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoCrop">
                                <label class="form-check-label" for="autoCrop">
                                    自动裁剪图片
                                </label>
                            </div>
                            <div class="form-text">自动裁剪图片以适应标准比例</div>
                        </div>

                        <!-- 去噪步骤 -->
                        <div class="mb-3">
                            <label for="denoiseSteps" class="form-label">去噪步骤数</label>
                            <input type="range" class="form-range" id="denoiseSteps" 
                                   min="1" max="50" value="25" oninput="updateStepsValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">1 (快速)</small>
                                <span id="stepsValue" class="badge bg-primary">25</span>
                                <small class="text-muted">50 (高质量)</small>
                            </div>
                            <div class="form-text">步骤越多，质量越高但时间越长</div>
                        </div>

                        <!-- 随机种子 -->
                        <div class="mb-3">
                            <label for="seed" class="form-label">随机种子</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="seed" 
                                       value="42" min="0" max="999999">
                                <button class="btn btn-outline-secondary" type="button" onclick="randomSeed()">
                                    <i class="bi bi-shuffle"></i>
                                </button>
                            </div>
                            <div class="form-text">相同种子产生相同结果，便于复现</div>
                        </div>

                        <!-- 预设配置 -->
                        <div class="mb-3">
                            <label class="form-label">快速配置</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="setPreset('fast')">
                                    快速
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPreset('normal')">
                                    标准
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="setPreset('quality')">
                                    高质量
                                </button>
                            </div>
                        </div>

                        <!-- 开始试穿按钮 -->
                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg" id="startTryonBtn" onclick="startVirtualTryon()" disabled>
                                <i class="bi bi-magic"></i> 开始虚拟试穿
                            </button>
                        </div>

                        <!-- 试穿进度 -->
                        <div id="tryonProgress" class="mt-3 d-none">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span id="progressText">正在处理中，请稍候...</span>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         style="width: 0%" id="progressBar"></div>
                                </div>
                                <small class="text-muted mt-1" id="timeEstimate"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 试穿结果 -->
        <div id="tryonResults" class="card mt-4 d-none">
            <div class="card-header">
                <h5><i class="bi bi-image"></i> 试穿结果</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>试穿效果</h6>
                        <div class="result-image-container">
                            <img id="resultImage" src="" alt="试穿结果" class="img-fluid rounded">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>生成遮罩</h6>
                        <div class="result-image-container">
                            <img id="maskImage" src="" alt="遮罩图片" class="img-fluid rounded">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div id="resultInfo" class="text-muted">
                                <!-- 结果信息 -->
                            </div>
                            <div>
                                <button class="btn btn-outline-primary me-2" onclick="downloadResult()">
                                    <i class="bi bi-download"></i> 下载结果
                                </button>
                                <button class="btn btn-success" onclick="startNewTryon()">
                                    <i class="bi bi-arrow-clockwise"></i> 重新试穿
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 试穿历史模态框 -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock-history"></i> 试穿历史</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="historyContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 全局变量
    let selectedHumanImage = null;
    let selectedGarmentImage = null;
    let tryonInProgress = false;

    document.addEventListener('DOMContentLoaded', function() {
        // 添加页面加载动效
        document.body.classList.add('fade-in');
        
        // 创建Toast容器
        createToastContainer();
        
        // 初始化检查服务状态
        setTimeout(() => {
            checkVtonService();
        }, 500);
        
        // 延迟加载图片以改善用户体验
        setTimeout(() => {
            loadUserImages('char', 'human');
        }, 800);
        
        setTimeout(() => {
            loadUserImages('clothes', 'garment');
        }, 1000);
        
        // 初始化UI状态
        updateUI();
        
        // 添加键盘快捷键支持
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter 开始试穿
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (!document.getElementById('startTryonBtn').disabled) {
                    startVirtualTryon();
                }
            }
            // Escape 清除选择
            else if (e.key === 'Escape') {
                if (selectedHumanImage) clearSelection('human');
                if (selectedGarmentImage) clearSelection('garment');
            }
        });
        
        // 添加工具提示
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    // 检查虚拟试穿服务状态
    async function checkVtonService() {
        try {
            const statusDiv = document.getElementById('serviceStatus');
            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> 正在检查虚拟试穿服务状态...';
            statusDiv.classList.remove('d-none');

            const response = await fetch('/api/vton/check');
            const data = await response.json();

            if (data.success) {
                statusDiv.className = 'alert alert-success';
                statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> 虚拟试穿服务正常运行 (${data.service_url})`;
                setTimeout(() => statusDiv.classList.add('d-none'), 3000);
            } else {
                statusDiv.className = 'alert alert-warning';
                statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${data.error}`;
            }
        } catch (error) {
            const statusDiv = document.getElementById('serviceStatus');
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> 无法连接到虚拟试穿服务，请确保服务正在运行`;
            statusDiv.classList.remove('d-none');
        }
    }

    // 加载用户图片
    async function loadUserImages(category, type) {
        try {
            const containerID = type === 'human' ? 'humanImageList' : 'garmentImageList';
            const container = document.getElementById(containerID);
            
            // 显示加载状态
            container.innerHTML = `
                <div class="text-center p-4 loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在加载${category === 'char' ? '角色' : '服装'}图片...</p>
                </div>
            `;

            // 更新分类标签页状态
            const tabsContainer = container.parentElement.previousElementSibling;
            if (tabsContainer) {
                updateTabButtons(tabsContainer, category);
            }
            
            console.log(`正在加载 ${category} 类别的图片，用于 ${type} 选择`);
            
            // 调用API获取文件路径
            let response = await fetch(`/api/user/file-paths?category=${category}&include_files=true`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            let data = await response.json();
            console.log('API响应:', data);

            if (data.success && data.paths && data.paths[category] && data.paths[category].files && data.paths[category].files.length > 0) {
                const files = data.paths[category].files;
                console.log(`找到 ${files.length} 个 ${category} 图片`);
                
                // 使用current作为用户ID，因为后端会自动处理用户身份
                container.innerHTML = files.map((file, index) => `
                    <div class="image-item fade-in" style="animation-delay: ${index * 0.1}s" onclick="selectImage('${file.filename}', '${type}', '${category}')">
                        <div class="image-wrapper">
                            <img src="/api/user/current/images/${category}/${file.filename}" 
                                 alt="${file.filename}" 
                                 class="img-thumbnail"
                                 onload="this.parentElement.parentElement.classList.add('loaded')"
                                 onerror="this.parentElement.innerHTML='<div class=error-img><i class=bi bi-image></i></div>'">
                            <div class="image-overlay">
                                <i class="bi bi-check-circle"></i>
                            </div>
                        </div>
                        <small class="image-name" title="${file.filename}">${file.filename}</small>
                    </div>
                `).join('');
            } else {
                console.log(`没有找到 ${category} 图片`);
                container.innerHTML = `
                    <div class="text-center p-4 empty-state fade-in">
                        <i class="bi bi-images text-muted" style="font-size: 3rem;"></i>
                        <h6 class="mt-3 text-muted">暂无${category === 'char' ? '角色' : '服装'}图片</h6>
                        <p class="text-muted mb-3">请先上传一些${category === 'char' ? '人物角色' : '服装'}图片</p>
                        <a href="/" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-upload"></i> 去上传图片
                        </a>
                    </div>
                `;
            }
        } catch (error) {
            console.error('加载图片失败:', error);
            const containerID = type === 'human' ? 'humanImageList' : 'garmentImageList';
            document.getElementById(containerID).innerHTML = `
                <div class="text-center p-4 error-state fade-in">
                    <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2.5rem;"></i>
                    <h6 class="mt-3 text-danger">加载失败</h6>
                    <p class="text-muted mb-3">错误信息: ${error.message}</p>
                    <button class="btn btn-outline-danger btn-sm" onclick="loadUserImages('${category}', '${type}')">
                        <i class="bi bi-arrow-clockwise"></i> 重新加载
                    </button>
                </div>
            `;
        }
    }

    // 选择图片
    function selectImage(filename, type, category) {
        // 添加选择动效
        const allItems = document.querySelectorAll(`#${type}ImageList .image-item`);
        allItems.forEach(item => item.classList.remove('selected'));
        
        // 找到被选中的图片项并添加选中效果
        const selectedItem = Array.from(allItems).find(item => 
            item.querySelector('img')?.src.includes(filename)
        );
        if (selectedItem) {
            selectedItem.classList.add('selected');
        }
        
        if (type === 'human') {
            selectedHumanImage = filename;
            const imgElement = document.getElementById('selectedHumanImg');
            const nameElement = document.getElementById('selectedHumanName');
            const container = document.getElementById('selectedHuman');
            
            // 淡出效果
            container.style.opacity = '0';
            
            setTimeout(() => {
                imgElement.src = `/api/user/current/images/${category}/${filename}`;
                nameElement.textContent = filename;
                container.classList.remove('d-none');
                
                // 淡入效果
                container.style.opacity = '1';
                container.classList.add('slide-down-active');
            }, 150);
            
        } else {
            selectedGarmentImage = filename;
            const imgElement = document.getElementById('selectedGarmentImg');
            const nameElement = document.getElementById('selectedGarmentName');
            const container = document.getElementById('selectedGarment');
            
            // 淡出效果
            container.style.opacity = '0';
            
            setTimeout(() => {
                imgElement.src = `/api/user/current/images/${category}/${filename}`;
                nameElement.textContent = filename;
                container.classList.remove('d-none');
                
                // 淡入效果
                container.style.opacity = '1';
                container.classList.add('slide-down-active');
            }, 150);
        }
        
        updateUI();
        
        // 显示成功提示
        showToast(`已选择${type === 'human' ? '人物' : '服装'}图片: ${filename}`, 'success');
    }

    // 清除选择
    function clearSelection(type) {
        if (type === 'human') {
            selectedHumanImage = null;
            const container = document.getElementById('selectedHuman');
            container.classList.add('d-none');
            container.classList.remove('slide-down-active');
        } else {
            selectedGarmentImage = null;
            const container = document.getElementById('selectedGarment');
            container.classList.add('d-none');
            container.classList.remove('slide-down-active');
        }
        
        // 清除选中状态
        const allItems = document.querySelectorAll(`#${type}ImageList .image-item`);
        allItems.forEach(item => item.classList.remove('selected'));
        
        updateUI();
        showToast(`已取消选择${type === 'human' ? '人物' : '服装'}图片`, 'info');
    }

    // 显示Toast提示
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        // 自动移除
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    // 创建Toast容器
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }

    // 更新UI状态
    function updateUI() {
        const startBtn = document.getElementById('startTryonBtn');
        const canStart = selectedHumanImage && selectedGarmentImage && !tryonInProgress;
        
        startBtn.disabled = !canStart;
        if (canStart) {
            startBtn.innerHTML = '<i class="bi bi-magic"></i> 开始虚拟试穿';
        } else if (tryonInProgress) {
            startBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 处理中...';
        } else {
            startBtn.innerHTML = '<i class="bi bi-magic"></i> 请选择图片';
        }
    }

    // 更新步骤数值显示
    function updateStepsValue(value) {
        document.getElementById('stepsValue').textContent = value;
    }

    // 生成随机种子
    function randomSeed() {
        const seed = Math.floor(Math.random() * 10000);
        document.getElementById('seed').value = seed;
    }

    // 设置预设配置
    function setPreset(preset) {
        switch (preset) {
            case 'fast':
                document.getElementById('autoMask').checked = false;
                document.getElementById('autoCrop').checked = false;
                document.getElementById('denoiseSteps').value = 15;
                updateStepsValue(15);
                break;
            case 'normal':
                document.getElementById('autoMask').checked = true;
                document.getElementById('autoCrop').checked = false;
                document.getElementById('denoiseSteps').value = 25;
                updateStepsValue(25);
                break;
            case 'quality':
                document.getElementById('autoMask').checked = true;
                document.getElementById('autoCrop').checked = false;
                document.getElementById('denoiseSteps').value = 40;
                updateStepsValue(40);
                break;
        }
    }

    // 开始虚拟试穿
    async function startVirtualTryon() {
        if (!selectedHumanImage || !selectedGarmentImage || tryonInProgress) {
            return;
        }

        tryonInProgress = true;
        updateUI();

        // 显示进度
        const progressDiv = document.getElementById('tryonProgress');
        const resultsDiv = document.getElementById('tryonResults');
        progressDiv.classList.remove('d-none');
        resultsDiv.classList.add('d-none');

        // 模拟进度更新
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('timeEstimate').textContent = 
                `预计剩余时间: ${Math.max(1, Math.floor((100 - progress) * 2))} 秒`;
        }, 1000);

        try {
            const requestData = {
                human_image: selectedHumanImage,
                garment_image: selectedGarmentImage,
                garment_description: document.getElementById('garmentDescription').value,
                auto_mask: document.getElementById('autoMask').checked,
                auto_crop: document.getElementById('autoCrop').checked,
                denoise_steps: parseInt(document.getElementById('denoiseSteps').value),
                seed: parseInt(document.getElementById('seed').value)
            };

            document.getElementById('progressText').textContent = '正在进行虚拟试穿，请稍候...';

            const response = await fetch('/api/vton/tryon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            clearInterval(progressInterval);
            document.getElementById('progressBar').style.width = '100%';

            if (response.ok) {
                const data = await response.json();
                
                if (data.success) {
                    // 显示结果
                    document.getElementById('resultImage').src = data.result.result_image;
                    document.getElementById('maskImage').src = data.result.mask_image;
                    
                    document.getElementById('resultInfo').innerHTML = `
                        <small>
                            处理时间: ${data.result.processing_time.toFixed(2)}秒 | 
                            参数: 步骤=${data.result.parameters.denoise_steps}, 种子=${data.result.parameters.seed}
                        </small>
                    `;
                    
                    progressDiv.classList.add('d-none');
                    resultsDiv.classList.remove('d-none');
                    
                    // 滚动到结果区域
                    resultsDiv.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.error);
                }
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || '请求失败');
            }

        } catch (error) {
            clearInterval(progressInterval);
            progressDiv.classList.add('d-none');
            
            alert(`虚拟试穿失败: ${error.message}`);
            console.error('虚拟试穿失败:', error);
        } finally {
            tryonInProgress = false;
            updateUI();
        }
    }

    // 下载结果
    function downloadResult() {
        const resultImg = document.getElementById('resultImage');
        if (resultImg.src) {
            const link = document.createElement('a');
            link.download = `vton_result_${new Date().getTime()}.png`;
            link.href = resultImg.src;
            link.click();
        }
    }

    // 开始新的试穿
    function startNewTryon() {
        document.getElementById('tryonResults').classList.add('d-none');
        document.getElementById('tryonProgress').classList.add('d-none');
        randomSeed(); // 生成新的随机种子
    }

    // 显示试穿历史
    async function showVtonHistory() {
        try {
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();

            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

            const response = await fetch('/api/vton/history');
            const data = await response.json();

            if (data.success && data.history.length > 0) {
                historyContent.innerHTML = data.history.map(item => `
                    <div class="row mb-3 p-3 border rounded">
                        <div class="col-md-3">
                            <img src="${item.result_url}" alt="试穿结果" class="img-fluid rounded">
                        </div>
                        <div class="col-md-9">
                            <h6>试穿记录</h6>
                            <p><strong>人物图片:</strong> ${item.human_image}</p>
                            <p><strong>服装图片:</strong> ${item.garment_image}</p>
                            <p><strong>处理时间:</strong> ${item.processing_time?.toFixed(2) || 'N/A'}秒</p>
                            <p><strong>创建时间:</strong> ${new Date(item.created_at).toLocaleString()}</p>
                            <div>
                                <a href="${item.result_url}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="bi bi-eye"></i> 查看结果
                                </a>
                                ${item.mask_url ? `
                                    <a href="${item.mask_url}" class="btn btn-sm btn-outline-secondary" target="_blank">
                                        <i class="bi bi-eye"></i> 查看遮罩
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                historyContent.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-clock-history" style="font-size: 3rem;"></i>
                        <p class="mt-3">暂无试穿历史</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('加载试穿历史失败:', error);
            document.getElementById('historyContent').innerHTML = `
                <div class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p>加载失败</p>
                </div>
            `;
        }
    }

    // 优化按钮点击逻辑
    function updateTabButtons(container, activeCategory) {
        const buttons = container.querySelectorAll('.btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-category') === activeCategory || 
                btn.textContent.includes(activeCategory === 'char' ? '角色' : '服装')) {
                btn.classList.add('active');
            }
        });
    }

    // 添加全局错误处理
    window.addEventListener('error', function(e) {
        console.error('页面错误:', e.error);
        showToast('页面发生错误，请刷新重试', 'error');
    });

    // 添加网络状态检测
    window.addEventListener('online', function() {
        showToast('网络连接已恢复', 'success');
    });

    window.addEventListener('offline', function() {
        showToast('网络连接已断开', 'error');
    });

    // 创建Toast容器
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }
</script>

<style>
    /* 按钮样式统一 */
    .category-tabs .btn {
        border-radius: 0;
        margin-right: -1px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .category-tabs .btn:first-child {
        border-top-left-radius: 0.375rem;
        border-bottom-left-radius: 0.375rem;
    }
    
    .category-tabs .btn:last-child {
        border-top-right-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }

    .category-tabs .btn.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }

    .category-tabs .btn:hover:not(.active) {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* 图片网格动效 */
    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.75rem;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        transition: all 0.3s ease;
    }

    .image-grid:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    }

    /* 图片项动效 */
    .image-item {
        position: relative;
        cursor: pointer;
        text-align: center;
        border-radius: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        transform: translateY(20px);
        background: white;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .image-item.loaded {
        opacity: 1;
        transform: translateY(0);
    }

    .image-item:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        z-index: 10;
    }

    .image-item.selected {
        border: 3px solid #28a745;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.4);
        transform: scale(1.05);
    }

    .image-item.selected .image-overlay {
        opacity: 1;
        background: rgba(40, 167, 69, 0.9);
    }

    .image-wrapper {
        position: relative;
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .image-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 0.375rem;
        transition: transform 0.3s ease;
    }

    .image-item:hover img {
        transform: scale(1.1);
    }

    .image-overlay {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(13, 110, 253, 0.9);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .image-item:hover .image-overlay {
        opacity: 1;
        transform: scale(1.1);
    }

    .image-name {
        display: block;
        margin-top: 8px;
        font-size: 0.75rem;
        color: #6c757d;
        word-break: break-all;
        font-weight: 500;
        transition: color 0.3s ease;
    }

    .image-item:hover .image-name {
        color: #0d6efd;
    }

    /* 选中图片预览动效 */
    .selected-image-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #dee2e6;
        border-radius: 0.75rem;
        padding: 20px;
        margin-top: 15px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        transform: translateY(-20px);
    }

    .selected-image-preview.slide-down-active {
        opacity: 1;
        transform: translateY(0);
        border-color: #28a745;
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.2);
    }

    .preview-image {
        max-width: 200px;
        max-height: 200px;
        object-fit: cover;
        border-radius: 0.5rem;
        transition: transform 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .preview-image:hover {
        transform: scale(1.05);
    }

    .clear-btn {
        border-radius: 50%;
        width: 28px;
        height: 28px;
        padding: 0;
        transition: all 0.3s ease;
        opacity: 0.8;
    }

    .clear-btn:hover {
        opacity: 1;
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    /* 结果容器动效 */
    .result-image-container {
        position: relative;
        border: 2px solid #dee2e6;
        border-radius: 0.75rem;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .result-image-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        transition: left 0.5s ease;
    }

    .result-image-container:hover::before {
        left: 100%;
    }

    .result-image-container:hover {
        border-color: #0d6efd;
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.15);
        transform: translateY(-2px);
    }

    .result-image-container img {
        width: 100%;
        height: auto;
        border-radius: 0.5rem;
        transition: transform 0.3s ease;
    }

    .result-image-container:hover img {
        transform: scale(1.02);
    }

    /* 按钮组优化 */
    .btn-group .btn-sm {
        font-size: 0.75rem;
        transition: all 0.3s ease;
    }

    .btn-group .btn-sm:hover {
        transform: translateY(-1px);
    }

    /* 进度条动效 */
    .progress {
        border-radius: 10px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.2);
    }

    .progress-bar {
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    /* 加载状态动效 */
    .loading-state {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }

    /* 淡入动效 */
    .fade-in {
        animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 滑入动效 */
    .slide-down {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 空状态样式 */
    .empty-state {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px dashed #dee2e6;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
    }

    .empty-state:hover {
        border-color: #0d6efd;
        background: linear-gradient(135deg, #e7f1ff 0%, #cfe2ff 100%);
    }

    /* 错误状态样式 */
    .error-state {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c2c7 100%);
        border: 2px solid #f5c2c7;
        border-radius: 0.75rem;
    }

    .error-img {
        width: 100%;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-radius: 0.375rem;
        color: #6c757d;
        font-size: 2rem;
    }

    /* 主要按钮动效 */
    .btn-primary.btn-lg {
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary.btn-lg::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .btn-primary.btn-lg:hover::before {
        left: 100%;
    }

    .btn-primary.btn-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.4);
    }

    .btn-primary.btn-lg:active {
        transform: translateY(0);
    }

    /* 卡片动效 */
    .card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    /* 响应式优化 */
    @media (max-width: 768px) {
        .image-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
        }
        
        .image-item img {
            height: 80px;
        }
        
        .preview-image {
            max-width: 150px;
            max-height: 150px;
        }
    }

    /* Toast样式优化 */
    .toast {
        backdrop-filter: blur(10px);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
</style>
{% endblock %}
